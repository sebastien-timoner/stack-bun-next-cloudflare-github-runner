#!/bin/bash

set -e

# Couleurs
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m' # No Color

# Afficher l'aide
show_help() {
    echo -e "${BLUE}╔════════════════════════════════════════╗${NC}"
    echo -e "${BLUE}║             Console Manager            ║${NC}"
    echo -e "${BLUE}╚════════════════════════════════════════╝${NC}"
    echo
    echo -e "${GREEN}Usage:${NC}"
    echo "  ./console [command] [options]"
    echo
    echo -e "${GREEN}Commands:${NC}"
    echo -e "  ${YELLOW}ssh-keygen${NC}      Generate SSH keys for deployment"
    echo -e "  ${YELLOW}export-ssh-key${NC}  Inject SSH key into .env automatically"
    echo -e "  ${YELLOW}start${NC}           Start the Docker container"
    echo -e "  ${YELLOW}stop${NC}            Stop the Docker container"
    echo -e "  ${YELLOW}restart${NC}         Restart the Docker container"
    echo -e "  ${YELLOW}build${NC}           Build the Docker image"
    echo -e "  ${YELLOW}logs${NC}            View container logs"
    echo -e "  ${YELLOW}shell${NC}           Open shell in running container"
    echo -e "  ${YELLOW}status${NC}          Show container status"
    echo -e "  ${YELLOW}up${NC}              Start services (docker compose up)"
    echo -e "  ${YELLOW}down${NC}            Stop and remove containers (docker compose down)"
    echo -e "  ${YELLOW}clean${NC}           Remove containers, volumes and images"
    echo -e "  ${YELLOW}help${NC}            Show this help message"
    echo
    echo -e "${GREEN}Examples:${NC}"
    echo "  ./console start"
    echo "  ./console logs -f"
    echo "  ./console shell"
    echo "  ./console clean"
}

# Vérifier que docker compose est disponible
check_docker() {
    if ! command -v docker compose &> /dev/null; then
        echo -e "${RED}Error: docker compose is not installed${NC}"
        exit 1
    fi
}

# Vérifier que .env existe
check_env() {
    if [ ! -f .env ]; then
        echo -e "${RED}Error: .env file not found${NC}"
        echo -e "${YELLOW}Please copy .env.example to .env and configure it${NC}"
        exit 1
    fi
}

# Commandes
cmd_ssh_keygen() {
    if [ -f .ssh/id_ed25519 ]; then
        echo -e "${YELLOW}⚠ SSH key already exists${NC}"
        read -p "Do you want to regenerate it? (y/N) " -n 1 -r
        echo
        if [[ ! $REPLY =~ ^[Yy]$ ]]; then
            echo -e "${YELLOW}Cancelled${NC}"
            return
        fi
    fi

    echo -e "${BLUE}Generating SSH key...${NC}"
    mkdir -p .ssh
    ssh-keygen -t ed25519 -C "deployment-key" -f .ssh/id_ed25519 -N ""
    chmod 600 .ssh/id_ed25519
    chmod 644 .ssh/id_ed25519.pub

    echo -e "${GREEN}✓ SSH key generated${NC}"
    echo
    echo -e "${BLUE}Public key:${NC}"
    cat .ssh/id_ed25519.pub
    echo
    echo -e "${YELLOW}Add this key to GitHub:${NC}"
    echo "1. Go to Repository Settings > Deploy keys"
    echo "2. Click 'Add deploy key'"
    echo "3. Paste the public key above"
    echo
    echo -e "${YELLOW}To add the private key to .env:${NC}"
    echo "  ./console export-ssh-key"
}

cmd_export_ssh_key() {
    if [ ! -f .ssh/id_ed25519 ]; then
        echo -e "${RED}Error: .ssh/id_ed25519 not found${NC}"
        echo -e "${YELLOW}Generate it first with: ./console ssh-keygen${NC}"
        exit 1
    fi

    if [ ! -f .env ]; then
        echo -e "${RED}Error: .env file not found${NC}"
        echo -e "${YELLOW}Copy .env.example to .env first: cp .env.example .env${NC}"
        exit 1
    fi

    echo -e "${BLUE}Exporting SSH key to .env...${NC}"

    # Generate the JSON-escaped key
    local ssh_key_json=$(cat .ssh/id_ed25519 | jq -Rs .)

    # Check if GIT_SSH_KEY already exists in .env
    if grep -q "^GIT_SSH_KEY=" .env; then
        # Replace existing GIT_SSH_KEY
        echo -e "${YELLOW}Updating existing GIT_SSH_KEY...${NC}"
        # Use sed with a different delimiter to avoid conflicts with the JSON content
        sed -i.bak "s|^GIT_SSH_KEY=.*|GIT_SSH_KEY=${ssh_key_json}|" .env
    else
        # Add new GIT_SSH_KEY
        echo -e "${YELLOW}Adding GIT_SSH_KEY to .env...${NC}"
        echo "GIT_SSH_KEY=${ssh_key_json}" >> .env
    fi

    echo -e "${GREEN}✓ SSH key exported to .env${NC}"
    echo -e "${BLUE}GIT_SSH_KEY value:${NC}"
    echo "${ssh_key_json}"
}

cmd_start() {
    check_docker
    check_env
    echo -e "${BLUE}Starting container...${NC}"
    docker compose up -d
    echo -e "${GREEN}✓ Container started${NC}"
}

cmd_stop() {
    check_docker
    echo -e "${BLUE}Stopping container...${NC}"
    docker compose down
    echo -e "${GREEN}✓ Container stopped${NC}"
}

cmd_restart() {
    check_docker
    check_env
    echo -e "${BLUE}Restarting container...${NC}"
    docker compose restart
    echo -e "${GREEN}✓ Container restarted${NC}"
}

cmd_build() {
    check_docker
    check_env
    echo -e "${BLUE}Building Docker image...${NC}"
    docker compose build --no-cache
    echo -e "${GREEN}✓ Image built${NC}"
}

cmd_logs() {
    check_docker
    docker compose logs "$@"
}

cmd_shell() {
    check_docker
    echo -e "${BLUE}Opening shell in container...${NC}"
    docker compose exec web sh
}

cmd_status() {
    check_docker
    docker compose ps
}

cmd_up() {
    check_docker
    check_env
    docker compose up "$@"
}

cmd_down() {
    check_docker
    docker compose down "$@"
}

cmd_clean() {
    check_docker
    echo -e "${RED}Warning: This will remove containers, volumes and images${NC}"
    read -p "Are you sure? (y/N) " -n 1 -r
    echo
    if [[ $REPLY =~ ^[Yy]$ ]]; then
        echo -e "${BLUE}Cleaning up...${NC}"
        docker compose down -v
        # Remove built images
        docker compose config --services | while read service; do
            docker rmi "$(docker compose images -q "$service")" 2>/dev/null || true
        done
        echo -e "${GREEN}✓ Cleanup complete${NC}"
    else
        echo -e "${YELLOW}Cancelled${NC}"
    fi
}

# Main
main() {
    local cmd="${1:-help}"

    case "$cmd" in
        ssh-keygen)
            cmd_ssh_keygen
            ;;
        export-ssh-key)
            cmd_export_ssh_key
            ;;
        start)
            cmd_start
            ;;
        stop)
            cmd_stop
            ;;
        restart)
            cmd_restart
            ;;
        build)
            cmd_build
            ;;
        logs)
            shift
            cmd_logs "$@"
            ;;
        shell)
            cmd_shell
            ;;
        status)
            cmd_status
            ;;
        up)
            shift
            cmd_up "$@"
            ;;
        down)
            shift
            cmd_down "$@"
            ;;
        clean)
            cmd_clean
            ;;
        help|--help|-h)
            show_help
            ;;
        *)
            echo -e "${RED}Unknown command: $cmd${NC}"
            show_help
            exit 1
            ;;
    esac
}

main "$@"
